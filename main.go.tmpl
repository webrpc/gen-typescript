{{- define "main" -}}

{{- /* Options with default values. */ -}}
{{- $opts := dict -}}
{{- set $opts "client" (ternary (in .Opts.client "" "true") true false) -}}
{{- set $opts "server" (ternary (in .Opts.server "" "true") true false) -}}
{{- set $opts "compat" (ternary (in .Opts.compat "" "true") true false) -}}
{{- set $opts "WebrpcHeader" (ternary (eq (default .Opts.WebrpcHeader "true") "false") false true) -}}

{{- /* Print help on -help. */ -}}
{{- if exists .Opts "help" -}}
  {{- template "help" $opts -}}
  {{- exit 0 -}}
{{- end -}}

{{- /* Print help on unsupported option. */ -}}
{{- range $k, $v := .Opts }}
  {{- if not (exists $opts $k) -}}
    {{- stderrPrintf "-%v=%q is not supported target option\n\nUsage:\n" $k $v -}}
    {{- template "help" $opts -}}
    {{- exit 1 -}}
  {{- end -}}
{{- end -}}

{{- if ne .WebrpcVersion "v1" -}}
  {{- stderrPrintf "%s generator error: unsupported Webrpc version %s\n" .WebrpcTarget .WebrpcVersion -}}
  {{- exit 1 -}}
{{- end -}}

{{- if not (minVersion .WebrpcGenVersion "v0.7.0") -}}
  {{- stderrPrintf "%s generator error: unsupported Webrpc-gen version %s, please update\n" .WebrpcTarget .WebrpcGenVersion -}}
  {{- exit 1 -}}
{{- end -}}

{{- set $opts "" false -}}
{{- range $_, $service := .Services -}}
  {{- range $_, $method := $service.Methods -}}
    {{ if eq $method.StreamOutput true -}}
      {{- set $opts "streaming" true -}}
    {{- end -}}
  {{- end -}}
{{- end }}

{{- /* Map Webrpc core types to JS. */ -}}
{{- $typeMap := dict }}
{{- set $typeMap "null" "null" -}}
{{- set $typeMap "any" "any" -}}
{{- set $typeMap "byte" "string" -}}
{{- set $typeMap "bool" "boolean" -}}
{{- set $typeMap "uint" "number" -}}
{{- set $typeMap "uint8" "number" -}}
{{- set $typeMap "uint16" "number" -}}
{{- set $typeMap "uint32" "number" -}}
{{- set $typeMap "uint64" "number" -}}
{{- set $typeMap "bigint" "bigint" -}}
{{- set $typeMap "int" "number" -}}
{{- set $typeMap "int8" "number" -}}
{{- set $typeMap "int16" "number" -}}
{{- set $typeMap "int32" "number" -}}
{{- set $typeMap "int64" "number" -}}
{{- set $typeMap "float32" "number" -}}
{{- set $typeMap "float64" "number" -}}
{{- set $typeMap "string" "string" -}}
{{- set $typeMap "timestamp" "string" -}}

/* eslint-disable */
// {{.SchemaName}} {{.SchemaVersion}} {{.SchemaHash}}
// --
// Code generated by Webrpc-gen@{{.WebrpcGenVersion}} with {{.WebrpcTarget}} generator. DO NOT EDIT.
//
// {{.WebrpcGenCommand}}

// Webrpc description and code-gen version
export const WebrpcVersion = "{{.WebrpcVersion}}"

// Schema version of your RIDL schema
export const WebrpcSchemaVersion = "{{.SchemaVersion}}"

// Schema hash generated from your RIDL schema
export const WebrpcSchemaHash = "{{.SchemaHash}}"

{{- "\n" -}}

{{- if $opts.client -}}
{{template "clientInterface" dict "Services" .Services "Opts" $opts "TypeMap" $typeMap}}
{{- end -}}

{{- "\n" -}}

{{- if $opts.server -}}
{{template "serverInterface" dict "Services" .Services "Opts" $opts "TypeMap" $typeMap}}
{{- end -}}

{{- "\n\n" -}}

{{template "types" dict "Types" .Types "Services" .Services "Opts" $opts "TypeMap" $typeMap}}

{{- "\n" -}}

{{- if $opts.client -}}
{{template "client" dict "Services" .Services "Opts" $opts "TypeMap" $typeMap}}
{{template "clientHelpers" dict "WebrpcErrors" .WebrpcErrors "SchemaErrors" .Errors "Opts" $opts }}
{{- end -}}

{{- "\n" -}}

{{- if $opts.server -}}
{{template "server" dict "Services" .Services "Opts" $opts "TypeMap" $typeMap}}
{{template "serverHelpers" dict "Types" .Types "TypeMap" $typeMap}}
{{- end -}}

{{- "\n\n" -}}

{{template "errors" dict "Services" .Services "WebrpcErrors" .WebrpcErrors "SchemaErrors" .Errors "Opts" $opts}}

//
// Webrpc
//

export const WebrpcHeader = "Webrpc"

export const WebrpcHeaderValue = "{{ .WebrpcHeader }}"

type WebrpcGenVersions = {
  WebrpcGenVersion: string;
  codeGenName: string;
  codeGenVersion: string;
  schemaName: string;
  schemaVersion: string;
};

export function VersionFromHeader(headers: Headers): WebrpcGenVersions {
  const headerValue = headers.get(WebrpcHeader)
  if (!headerValue) {
    return {
      WebrpcGenVersion: "",
      codeGenName: "",
      codeGenVersion: "",
      schemaName: "",
      schemaVersion: "",
    };
  }

  return parseWebrpcGenVersions(headerValue)
}

function parseWebrpcGenVersions(header: string): WebrpcGenVersions {
  const versions = header.split(";")
  if (versions.length < 3) {
    return {
      WebrpcGenVersion: "",
      codeGenName: "",
      codeGenVersion: "",
      schemaName: "",
      schemaVersion: "",
    };
  }

  const [_, WebrpcGenVersion] = versions[0]!.split("@")
  const [codeGenName, codeGenVersion] = versions[1]!.split("@")
  const [schemaName, schemaVersion] = versions[2]!.split("@")

  return {
    WebrpcGenVersion: WebrpcGenVersion ?? "",
    codeGenName: codeGenName ?? "",
    codeGenVersion: codeGenVersion ?? "",
    schemaName: schemaName ?? "",
    schemaVersion: schemaVersion ?? "",
  };
}

{{ template "bigintHelpers" dict "Schema" .WebRPCSchema "Services" .Services "Opts" $opts }}

{{end -}}
